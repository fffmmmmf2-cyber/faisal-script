-- LocalScript (StarterPlayerScripts)
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer
local camera = workspace.CurrentCamera

-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø©
local SEARCH_RADIUS = 60
local REFRESH_INTERVAL = 0.4
local LINE_THICKNESS = 0.5
local LINE_COLOR = Color3.fromRGB(255, 0, 0)
local LOCKED_LINE_COLOR = Color3.fromRGB(255, 255, 0)
local FOLDER_NAME = "LocalBorderLines"

-------------------------------------------------
-- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¹Ø±Ø¶
-------------------------------------------------
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "ModelNameDisplay"
screenGui.Parent = player:WaitForChild("PlayerGui")

local labelFrame = Instance.new("Frame")
labelFrame.Size = UDim2.new(0, 400, 0, 50)
labelFrame.Position = UDim2.new(1, -410, 0.5, -25)
labelFrame.BackgroundTransparency = 0.3
labelFrame.BackgroundColor3 = Color3.fromRGB(30, 0, 0)
labelFrame.Parent = screenGui
labelFrame.Visible = false

local label = Instance.new("TextLabel")
label.Size = UDim2.new(0.6, 0, 1, 0)
label.Position = UDim2.new(0, 10, 0, 0)
label.BackgroundTransparency = 1
label.TextColor3 = Color3.fromRGB(255, 0, 0)
label.Font = Enum.Font.SourceSansBold
label.TextScaled = true
label.Text = ""
label.Parent = labelFrame

local lockButton = Instance.new("TextButton")
lockButton.Size = UDim2.new(0.35, 0, 1, 0)
lockButton.Position = UDim2.new(0.63, 0, 0, 0)
lockButton.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
lockButton.TextColor3 = Color3.fromRGB(255, 255, 255)
lockButton.Font = Enum.Font.SourceSansBold
lockButton.TextScaled = true
lockButton.Text = "ØªØ­Ø¯ÙŠØ¯"
lockButton.Parent = labelFrame

-------------------------------------------------
-- Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØªØ­Ø¯ÙŠØ¯
-------------------------------------------------
local lockedModel = nil
local folder = nil
local rainbowConnection = nil
local rainbowSpeed = 0.3 -- Ø§Ù„Ø³Ø±Ø¹Ø© (ÙƒÙ„ Ù…Ø§ Ù‚Ù„Øª ØµØ§Ø±Øª Ø£Ù‡Ø¯Ø£)

-------------------------------------------------
-- Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©
-------------------------------------------------
local function getOrCreateFolder()
	if not folder or not folder.Parent then
		folder = Instance.new("Folder")
		folder.Name = FOLDER_NAME
		folder.Parent = camera
	else
		folder:ClearAllChildren()
	end
	return folder
end

local function clearFolder()
	if folder then
		folder:Destroy()
		folder = nil
	end
end

local function makeEdge(a, b, thickness, color, parent)
	local dir = (b - a)
	local dist = dir.Magnitude
	if dist <= 0.001 then return nil end
	local part = Instance.new("Part")
	part.Size = Vector3.new(thickness, thickness, dist)
	part.Anchored = true
	part.CanCollide = false
	part.Material = Enum.Material.Neon
	part.Color = color
	part.TopSurface = Enum.SurfaceType.Smooth
	part.BottomSurface = Enum.SurfaceType.Smooth
	part.CFrame = CFrame.new(a, b) * CFrame.new(0, 0, -dist / 2)
	part.Parent = parent
	return part
end

local function boundingBoxCorners(cf, size)
	local hx, hy, hz = size.X / 2, size.Y / 2, size.Z / 2
	local signs = {
		Vector3.new(-1, -1, -1),
		Vector3.new(-1, -1, 1),
		Vector3.new(-1, 1, -1),
		Vector3.new(-1, 1, 1),
		Vector3.new(1, -1, -1),
		Vector3.new(1, -1, 1),
		Vector3.new(1, 1, -1),
		Vector3.new(1, 1, 1),
	}
	local corners = {}
	for _, s in ipairs(signs) do
		table.insert(corners, cf:PointToWorldSpace(Vector3.new(s.X * hx, s.Y * hy, s.Z * hz)))
	end
	return corners, signs
end

-------------------------------------------------
-- ðŸŒˆ ØªØ£Ø«ÙŠØ± Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù…ØªØºÙŠØ±Ø©
-------------------------------------------------
local function startRainbowEffect(model)
	if rainbowConnection then
		rainbowConnection:Disconnect()
	end

	rainbowConnection = RunService.Heartbeat:Connect(function(deltaTime)
		local time = tick() * rainbowSpeed
		local hue = (time % 1)
		local color = Color3.fromHSV(hue, 1, 1)

		for _, part in ipairs(model:GetDescendants()) do
			if part:IsA("BasePart") then
				part.Color = color
				part.Material = Enum.Material.Neon
			end
		end
	end)
end

local function stopRainbowEffect()
	if rainbowConnection then
		rainbowConnection:Disconnect()
		rainbowConnection = nil
	end
end

-------------------------------------------------
-- Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£Ù‚Ø±Ø¨ Ù…ÙˆØ¯ÙŠÙ„
-------------------------------------------------
local function findNearestModel()
	local root = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
	local myPos = root and root.Position or camera.CFrame.Position

	local nearestModel = nil
	local nearestDist = math.huge

	for _, obj in ipairs(workspace:GetDescendants()) do
		if obj:IsA("Model") and obj.PrimaryPart and obj ~= player.Character then
			local bbCFrame, bbSize = obj:GetBoundingBox()
			local d = (bbCFrame.Position - myPos).Magnitude
			if d < nearestDist and d <= SEARCH_RADIUS then
				nearestDist = d
				nearestModel = {model = obj, cframe = bbCFrame, size = bbSize}
			end
		end
	end

	return nearestModel
end

-------------------------------------------------
-- Ø±Ø³Ù… Ø§Ù„Ø­Ø¯ÙˆØ¯
-------------------------------------------------
local function drawModel(modelData, color)
	local cf, size = modelData.cframe, modelData.size
	local corners, signs = boundingBoxCorners(cf, size)
	local folder = getOrCreateFolder()
	for i = 1, #corners do
		for j = i + 1, #corners do
			local diff = 0
			local si, sj = signs[i], signs[j]
			if si.X ~= sj.X then diff += 1 end
			if si.Y ~= sj.Y then diff += 1 end
			if si.Z ~= sj.Z then diff += 1 end
			if diff == 1 then
				makeEdge(corners[i], corners[j], LINE_THICKNESS, color, folder)
			end
		end
	end
end

-------------------------------------------------
-- ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ­Ø¯ÙŠØ¯
-------------------------------------------------
local function updateBorders()
	if lockedModel then
		clearFolder()
		local bbCFrame, bbSize = lockedModel:GetBoundingBox()
		drawModel({cframe = bbCFrame, size = bbSize}, LOCKED_LINE_COLOR)
		label.Text = "Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„ (Ø«Ø§Ø¨Øª): " .. lockedModel.Name
		labelFrame.Visible = true
		lockButton.Text = "Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ¯"
		lockButton.BackgroundColor3 = Color3.fromRGB(255, 200, 0)
		return
	end

	local target = findNearestModel()
	if not target then
		labelFrame.Visible = false
		clearFolder()
		return
	end

	clearFolder()
	drawModel(target, LINE_COLOR)
	label.Text = "Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„: " .. target.model.Name
	labelFrame.Visible = true
	lockButton.Text = "ØªØ­Ø¯ÙŠØ¯"
	lockButton.BackgroundColor3 = Color3.fromRGB(255, 0, 0)

	lockButton.MouseButton1Click:Connect(function()
		if not lockedModel then
			lockedModel = target.model
			startRainbowEffect(lockedModel)
		else
			stopRainbowEffect()
			lockedModel = nil
		end
	end)
end

-------------------------------------------------
-- Ø­Ù„Ù‚Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ«
-------------------------------------------------
task.spawn(function()
	while true do
		updateBorders()
		task.wait(REFRESH_INTERVAL)
	end
end)

player.AncestryChanged:Connect(function()
	if not player:IsDescendantOf(game) then
		clearFolder()
	end
end)

game:BindToClose(function()
	clearFolder()
	stopRainbowEffect()
end)
