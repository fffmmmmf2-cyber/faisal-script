-- Auto Walk to All "base" Parts v2
-- LocalScript داخل StarterPlayerScripts

local Players = game:GetService("Players")
local PathfindingService = game:GetService("PathfindingService")
local RunService = game:GetService("RunService")
local StarterGui = game:GetService("StarterGui")

local player = Players.LocalPlayer
local function getChar()
	return player.Character or player.CharacterAdded:Wait()
end

-- ===== GUI =====
local screen = Instance.new("ScreenGui", player:WaitForChild("PlayerGui"))
screen.Name = "AutoPathUI_v2"

local button = Instance.new("TextButton")
button.Size = UDim2.new(0, 180, 0, 48)
button.Position = UDim2.new(0, 12, 0.5, -24)
button.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
button.Text = "ابدأ التنقل التلقائي"
button.TextColor3 = Color3.fromRGB(255,255,255)
button.TextScaled = true
button.Font = Enum.Font.GothamBold
button.Parent = screen

local uic = Instance.new("UICorner", button)
uic.CornerRadius = UDim.new(0,16)

-- ===== مسار مرسوم =====
local pathFolder = Instance.new("Folder", workspace)
pathFolder.Name = "PathVis"

local function clearPath()
	for _, obj in ipairs(pathFolder:GetChildren()) do
		obj:Destroy()
	end
end

local function drawSegment(p0, p1)
	local dir = (p1 - p0)
	local dist = dir.Magnitude
	if dist < 0.05 then return end

	local part = Instance.new("Part")
	part.Anchored = true
	part.CanCollide = false
	part.Material = Enum.Material.Neon
	part.Color = Color3.fromRGB(0, 170, 255)
	part.Size = Vector3.new(0.25, 0.25, dist)
	part.CFrame = CFrame.lookAt((p0 + p1)/2, p1) * CFrame.new(0,0,-dist/2)
	part.Parent = pathFolder
end

local function drawPath(waypoints)
	clearPath()
	for i, wp in ipairs(waypoints) do
		if i > 1 then
			drawSegment(waypoints[i-1].Position, wp.Position)
		end
	end
end

-- ===== حساب المسار =====
local function computePath(startPos, goalPos)
	local path = PathfindingService:CreatePath({
		AgentRadius = 2.5,
		AgentHeight = 5,
		AgentCanJump = true
	})
	path:ComputeAsync(startPos, goalPos)
	if path.Status == Enum.PathStatus.Success then
		return path
	end
	return nil
end

-- ===== يجيب أقرب base =====
local function getNearestBase(fromPos, visited)
	local nearest, bestDist
	for _, d in ipairs(workspace:GetDescendants()) do
		if d:IsA("BasePart") and d.Name:lower() == "base" and not visited[d] then
			local dist = (d.Position - fromPos).Magnitude
			if not bestDist or dist < bestDist then
				nearest, bestDist = d, dist
			end
		end
	end
	return nearest
end

-- ===== التنقل =====
local autoRunning = false

local function autoWalk()
	if autoRunning then 
		autoRunning = false
		button.Text = "ابدأ التنقل التلقائي"
		clearPath()
		return
	end
	
	autoRunning = true
	button.Text = "إيقاف"

	local char = getChar()
	local hrp = char:WaitForChild("HumanoidRootPart")
	local hum = char:WaitForChild("Humanoid")

	local visited = {}
	
	while autoRunning do
		local target = getNearestBase(hrp.Position, visited)
		if not target then
			StarterGui:SetCore("SendNotification", {
				Title = "اكتمل",
				Text = "ما عاد فيه بارت اسمه base",
				Duration = 3
			})
			break
		end

		local path = computePath(hrp.Position, target.Position + Vector3.new(0,2,0))
		if path then
			drawPath(path:GetWaypoints())
			for _, wp in ipairs(path:GetWaypoints()) do
				if wp.Action == Enum.PathWaypointAction.Jump then
					hum.Jump = true
				end
				hum:MoveTo(wp.Position)
				hum.MoveToFinished:Wait()
				if not autoRunning then break end
			end
		end
		
		if (target.Position - hrp.Position).Magnitude < 6 then
			visited[target] = true
		end
		RunService.Heartbeat:Wait()
	end
	
	autoRunning = false
	button.Text = "ابدأ التنقل التلقائي"
	clearPath()
end

button.MouseButton1Click:Connect(autoWalk)
