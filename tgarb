local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

local highlightFolder = Instance.new("Folder")
highlightFolder.Name = "PlayerHighlights"
highlightFolder.Parent = workspace

local highlights = {}
local currentTarget = nil
local lastGreenTime = 0

-- يعطي اللاعب Highlight إذا ما عنده
local function getHighlight(char)
    if not char then return end
    if highlights[char] then return highlights[char] end

    local h = Instance.new("Highlight")
    h.FillTransparency = 0.3
    h.OutlineTransparency = 0
    h.Parent = highlightFolder
    highlights[char] = h

    return h
end

-- فحص رؤية
local function isVisible(targetChar)
    if not (LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Head")) then return false end
    if not (targetChar and targetChar:FindFirstChild("Head")) then return false end

    local origin = LocalPlayer.Character.Head.Position
    local target = targetChar.Head.Position

    local params = RaycastParams.new()
    params.FilterType = Enum.RaycastFilterType.Blacklist
    params.FilterDescendantsInstances = {LocalPlayer.Character}

    local direction = target - origin
    local result = workspace:Raycast(origin, direction, params)

    if not result then
        return true
    end

    if result.Instance and result.Instance:IsDescendantOf(targetChar) then
        return true
    end

    return false
end

-- يحدد اللون الأحمر/الأخضر بدون إعادة كل شيء
local function updateColors()
    for _, plr in ipairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer and plr.Character then
            local char = plr.Character
            local h = getHighlight(char)
            h.Adornee = char

            if isVisible(char) then
                h.FillColor = Color3.fromRGB(0,255,0) -- أخضر
                h.OutlineColor = Color3.fromRGB(0,255,0)
            else
                h.FillColor = Color3.fromRGB(255,0,0) -- أحمر
                h.OutlineColor = Color3.fromRGB(255,0,0)
            end
        end
    end
end

-- اختيار أقرب لاعب أخضر فقط كل 0.3 ثانية
local function updateTarget()
    local nearest = nil
    local nearestDist = math.huge

    if not (LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Head")) then return end
    local myPos = LocalPlayer.Character.Head.Position

    for _, plr in ipairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer and plr.Character then
            local char = plr.Character
            local h = highlights[char]

            if h and h.FillColor == Color3.fromRGB(0,255,0) then
                local head = char:FindFirstChild("Head")
                if head then
                    local dist = (head.Position - myPos).Magnitude
                    if dist < nearestDist then
                        nearest = char
                        nearestDist = dist
                    end
                end
            end
        end
    end

    currentTarget = nearest
end

-- تتبع الكاميرا للهدف الأخضر (تثبيت قوي)
local function updateCameraFollow()
    if currentTarget and currentTarget:FindFirstChild("Head") then
        local head = currentTarget.Head
        Camera.CFrame = CFrame.new(Camera.CFrame.Position, head.Position)
    end
end

-- تحديث اللون سريع
task.spawn(function()
    while true do
        updateColors()
        task.wait(0.1)
    end
end)

-- اختيار أقرب هدف
task.spawn(function()
    while true do
        updateTarget()
        task.wait(0.3)
    end
end)

-- تتبع الكاميرا
task.spawn(function()
    while true do
        updateCameraFollow()
        task.wait(0.02) -- تتبع ناعم جداً
    end
end)
