local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

local highlightFolder = Instance.new("Folder")
highlightFolder.Name = "PlayerHighlights"
highlightFolder.Parent = workspace

local highlights = {}
local currentTarget = nil
local lastPositions = {}
local stationaryTime = {}

-- يضيف Highlight إذا ناقص
local function getHighlight(char)
    if not char then return end
    if highlights[char] then return highlights[char] end

    local h = Instance.new("Highlight")
    h.FillTransparency = 0.3
    h.OutlineTransparency = 0
    h.Parent = highlightFolder
    highlights[char] = h

    return h
end

-- فحص رؤية
local function isVisible(targetChar)
    if not (LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Head")) then return false end
    if not (targetChar and targetChar:FindFirstChild("Head")) then return false end

    local origin = LocalPlayer.Character.Head.Position
    local target = targetChar.Head.Position

    local params = RaycastParams.new()
    params.FilterType = Enum.RaycastFilterType.Blacklist
    params.FilterDescendantsInstances = {LocalPlayer.Character}

    local dir = target - origin
    local ray = workspace:Raycast(origin, dir, params)

    if not ray then
        return true
    end

    if ray.Instance and ray.Instance:IsDescendantOf(targetChar) then
        return true
    end

    return false
end

-- تحديث اللون بدون إعادة كل شيء
local function updateColors()
    for _, plr in ipairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer and plr.Character then
            local char = plr.Character
            local h = getHighlight(char)
            h.Adornee = char

            if isVisible(char) then
                h.FillColor = Color3.fromRGB(0,255,0)
                h.OutlineColor = Color3.fromRGB(0,255,0)
            else
                h.FillColor = Color3.fromRGB(255,0,0)
                h.OutlineColor = Color3.fromRGB(255,0,0)
            end
        end
    end
end

-- كل 10 ثواني يتأكد من كل اللاعبين ويضيف Highlight إذا ناقص
task.spawn(function()
    while true do
        for _, plr in ipairs(Players:GetPlayers()) do
            if plr ~= LocalPlayer and plr.Character then
                getHighlight(plr.Character)
            end
        end
        task.wait(10)
    end
end)

-- تسجيل آخر موقع اللاعب
local function updatePlayerMovement()
    for _, plr in ipairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
            local hrp = plr.Character.HumanoidRootPart
            local lastPos = lastPositions[plr] or hrp.Position
            local dist = (hrp.Position - lastPos).Magnitude

            if dist < 0.1 then
                stationaryTime[plr] = (stationaryTime[plr] or 0) + 0.1
            else
                stationaryTime[plr] = 0
            end

            lastPositions[plr] = hrp.Position
        end
    end
end

-- اختيار أقرب لاعب أخضر متحرك فقط
local function updateTarget()
    local nearest = nil
    local nearestDist = math.huge
    if not (LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")) then return end
    local myPos = LocalPlayer.Character.HumanoidRootPart.Position

    for _, plr in ipairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer and plr.Character then
            local char = plr.Character
            local h = highlights[char]
            local stationary = stationaryTime[plr] or 0

            if h and h.FillColor == Color3.fromRGB(0,255,0) and stationary < 7 then
                local hrp = char:FindFirstChild("HumanoidRootPart")
                if hrp then
                    local dist = (hrp.Position - myPos).Magnitude
                    if dist < nearestDist then
                        nearestDist = dist
                        nearest = char
                    end
                end
            end
        end
    end

    currentTarget = nearest
end

-- تتبع الكاميرا
local function updateCameraFollow()
    if currentTarget and currentTarget:FindFirstChild("Head") then
        local head = currentTarget.Head
        Camera.CFrame = CFrame.new(Camera.CFrame.Position, head.Position)
    end
end

-- كل 0.1 ثانية تحديث الألوان
task.spawn(function()
    while true do
        updateColors()
        updatePlayerMovement()
        task.wait(0.1)
    end
end)

-- كل 0.3 ثانية تحديث الهدف
task.spawn(function()
    while true do
        updateTarget()
        task.wait(0.3)
    end
end)

-- تحديث الكاميرا بسرعة عالية لتثبيت التتبع
task.spawn(function()
    while true do
        updateCameraFollow()
        task.wait(0.02)
    end
end)
