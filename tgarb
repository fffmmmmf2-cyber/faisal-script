-- صنع واجهة
local player = game.Players.LocalPlayer
local cam = workspace.CurrentCamera
local rs = game:GetService("RunService")
local TweenService = game:GetService("TweenService")

local gui = Instance.new("ScreenGui", player:WaitForChild("PlayerGui"))
local nameLabel = Instance.new("TextLabel", gui)
local selectButton = Instance.new("TextButton", gui)
local cancelButton = Instance.new("TextButton", gui)

-- إعداد النصوص
gui.ResetOnSpawn = false
nameLabel.Size = UDim2.new(0, 250, 0, 40)
nameLabel.Position = UDim2.new(1, -260, 0, 100)
nameLabel.AnchorPoint = Vector2.new(0, 0)
nameLabel.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
nameLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
nameLabel.Font = Enum.Font.SourceSansBold
nameLabel.TextScaled = true
nameLabel.Text = "لا يوجد موديل قريب"

selectButton.Size = UDim2.new(0, 120, 0, 40)
selectButton.Position = UDim2.new(1, -130, 0, 150)
selectButton.AnchorPoint = Vector2.new(0, 0)
selectButton.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
selectButton.TextColor3 = Color3.fromRGB(255, 255, 255)
selectButton.Font = Enum.Font.SourceSansBold
selectButton.TextScaled = true
selectButton.Text = "تحديد"

cancelButton.Size = UDim2.new(0, 120, 0, 40)
cancelButton.Position = UDim2.new(1, -130, 0, 200)
cancelButton.AnchorPoint = Vector2.new(0, 0)
cancelButton.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
cancelButton.TextColor3 = Color3.fromRGB(255, 255, 255)
cancelButton.Font = Enum.Font.SourceSansBold
cancelButton.TextScaled = true
cancelButton.Text = "إلغاء التحديد"
cancelButton.Visible = false

local selectedModel = nil
local fixedModel = false
local rainbowActive = false

-- دالة لصنع حدود حمراء حول الموديل
local function highlightModel(model)
	for _, part in ipairs(model:GetDescendants()) do
		if part:IsA("BasePart") then
			local selectionBox = Instance.new("SelectionBox")
			selectionBox.Adornee = part
			selectionBox.Color3 = Color3.fromRGB(255, 0, 0)
			selectionBox.LineThickness = 0.1
			selectionBox.Parent = part
		end
	end
end

local function removeHighlights(model)
	for _, part in ipairs(model:GetDescendants()) do
		if part:FindFirstChildOfClass("SelectionBox") then
			part:FindFirstChildOfClass("SelectionBox"):Destroy()
		end
	end
end

-- دالة الرينبو
local function startRainbow(model)
	rainbowActive = true
	task.spawn(function()
		local hue = 0
		while rainbowActive and model and model.Parent do
			hue = (hue + 0.003) % 1
			local color = Color3.fromHSV(hue, 1, 1)
			for _, part in ipairs(model:GetDescendants()) do
				if part:IsA("BasePart") then
					TweenService:Create(part, TweenInfo.new(0.15, Enum.EasingStyle.Linear), {Color = color}):Play()
				end
			end
			task.wait(0.05)
		end
	end)
end

local function stopRainbow(model)
	rainbowActive = false
	if model and model.Parent then
		for _, part in ipairs(model:GetDescendants()) do
			if part:IsA("BasePart") then
				part.Color = part.BrickColor.Color
			end
		end
	end
end

-- البحث عن أقرب موديل
local function getClosestModel()
	local closest, distance = nil, math.huge
	for _, model in ipairs(workspace:GetChildren()) do
		if model:IsA("Model") and model ~= player.Character then
			local primary = model.PrimaryPart or model:FindFirstChildWhichIsA("BasePart")
			if primary then
				local dist = (primary.Position - cam.CFrame.Position).Magnitude
				if dist < distance and dist < 40 then
					closest, distance = model, dist
				end
			end
		end
	end
	return closest
end

-- متابعة التحديد التلقائي
rs.RenderStepped:Connect(function()
	if fixedModel then return end
	local model = getClosestModel()
	if model ~= selectedModel then
		if selectedModel then removeHighlights(selectedModel) end
		selectedModel = model
		if model then
			highlightModel(model)
			nameLabel.Text = "الموديل: " .. model.Name
		else
			nameLabel.Text = "لا يوجد موديل قريب"
		end
	end
end)

-- عند الضغط على زر "تحديد"
selectButton.MouseButton1Click:Connect(function()
	if selectedModel then
		fixedModel = true
		selectButton.Visible = false
		cancelButton.Visible = true
		startRainbow(selectedModel)
	end
end)

-- عند الضغط على زر "إلغاء التحديد"
cancelButton.MouseButton1Click:Connect(function()
	if selectedModel then
		stopRainbow(selectedModel)
		removeHighlights(selectedModel)
		fixedModel = false
		selectButton.Visible = true
		cancelButton.Visible = false
		nameLabel.Text = "لا يوجد موديل قريب"
		selectedModel = nil
	end
end)
