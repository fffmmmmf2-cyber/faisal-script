local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

-- ESP + Highlight
local function createESP(char)
    if not char then return end
    if char:FindFirstChild("HumanoidRootPart") == nil then return end

    if char:FindFirstChild("ESP_Box") then
        char.ESP_Box:Destroy()
    end
    if char:FindFirstChild("ESP_Line") then
        char.ESP_Line:Destroy()
    end

    local h = Instance.new("Highlight")
    h.Name = "ESP_Box"
    h.FillTransparency = 0.2
    h.OutlineTransparency = 0
    h.FillColor = Color3.new(1, 0, 0)
    h.OutlineColor = Color3.new(1, 0, 0)
    h.Parent = char

    -- الخط (Beam)
    local a0 = Instance.new("Attachment")
    a0.Name = "StartPoint"
    a0.Parent = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") or nil

    local a1 = Instance.new("Attachment")
    a1.Name = "EndPoint"
    a1.Parent = char:FindFirstChild("HumanoidRootPart")

    local beam = Instance.new("Beam")
    beam.Name = "ESP_Line"
    beam.Attachment0 = a0
    beam.Attachment1 = a1
    beam.FaceCamera = true
    beam.Enabled = false   -- الخط ما يشتغل إلا لما يصبح أخضر
    beam.Width0 = 0.15
    beam.Width1 = 0.15
    beam.Parent = char
end

-- فحص الجدار
local function isVisible(targetChar)
    if not LocalPlayer.Character or not LocalPlayer.Character:FindFirstChild("Head") then return false end
    if not targetChar or not targetChar:FindFirstChild("Head") then return false end

    local origin = LocalPlayer.Character.Head.Position
    local target = targetChar.Head.Position

    local rayParams = RaycastParams.new()
    rayParams.FilterType = Enum.RaycastFilterType.Blacklist
    rayParams.FilterDescendantsInstances = {LocalPlayer.Character}

    local ray = workspace:Raycast(origin, (target - origin).Unit * 9999, rayParams)

    if not ray then
        return true
    end

    if ray.Instance and ray.Instance:IsDescendantOf(targetChar) then
        return true
    end

    return false
end

-- تحديث الألوان + الخط
local function updateColors()
    for _, plr in pairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer then
            local char = plr.Character
            if char and char:FindFirstChild("ESP_Box") then
                local box = char:FindFirstChild("ESP_Box")
                local line = char:FindFirstChild("ESP_Line")

                if isVisible(char) then
                    -- اللون الأخضر
                    box.FillColor = Color3.new(0, 1, 0)
                    box.OutlineColor = Color3.new(0, 1, 0)

                    -- تشغيل الخط
                    if line then
                        line.Enabled = true
                        line.Color = ColorSequence.new(Color3.new(0,1,0))
                    end
                else
                    -- الأحمر
                    box.FillColor = Color3.new(1, 0, 0)
                    box.OutlineColor = Color3.new(1, 0, 0)

                    -- إطفاء الخط
                    if line then
                        line.Enabled = false
                    end
                end
            end
        end
    end
end

-- إضافة ESP لكل اللاعبين
local function refreshAll()
    for _, plr in pairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer then
            if plr.Character then
                createESP(plr.Character)
            end
            plr.CharacterAdded:Connect(function(ch)
                task.wait(1)
                createESP(ch)
            end)
        end
    end
end

-- تحديث كل 3 ثواني
task.spawn(function()
    while true do
        refreshAll()
        task.wait(3)
    end
end)

-- فحص الرؤية + الخط كل 0.5 ثانية
task.spawn(function()
    while true do
        updateColors()
        task.wait(0.5)
    end
end)
