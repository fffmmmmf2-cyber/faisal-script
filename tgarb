-- LocalScript (حطّه في StarterPlayerScripts)
-- يكتشف كل RemoteEvent في اللعبة ويعرض الأسماء في ScrollingFrame قابلة للتمرير

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

-- إعداد الواجهة (ScreenGui -> Frame -> Title + Refresh + ScrollingFrame)
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "RemoteEventsLister"
screenGui.ResetOnSpawn = false
screenGui.Parent = playerGui

local mainFrame = Instance.new("Frame")
mainFrame.Name = "MainFrame"
mainFrame.Size = UDim2.new(0, 360, 0, 380)
mainFrame.Position = UDim2.new(0, 20, 0, 80)
mainFrame.AnchorPoint = Vector2.new(0,0)
mainFrame.BackgroundTransparency = 0.15
mainFrame.BackgroundColor3 = Color3.fromRGB(30,30,30)
mainFrame.BorderSizePixel = 0
mainFrame.Parent = screenGui
mainFrame.Active = true
mainFrame.Draggable = true -- تقدر تحرّك النافذة في الإستوديو

local title = Instance.new("TextLabel")
title.Name = "Title"
title.Size = UDim2.new(1, -20, 0, 36)
title.Position = UDim2.new(0, 10, 0, 10)
title.BackgroundTransparency = 1
title.Text = "قائمة RemoteEvents"
title.TextScaled = true
title.Font = Enum.Font.GothamBold
title.TextColor3 = Color3.fromRGB(255,255,255)
title.Parent = mainFrame

local refreshBtn = Instance.new("TextButton")
refreshBtn.Name = "Refresh"
refreshBtn.Size = UDim2.new(0, 90, 0, 30)
refreshBtn.Position = UDim2.new(1, -100, 0, 8)
refreshBtn.AnchorPoint = Vector2.new(1,0)
refreshBtn.BackgroundColor3 = Color3.fromRGB(50,50,50)
refreshBtn.Text = "تحديث"
refreshBtn.Font = Enum.Font.Gotham
refreshBtn.TextColor3 = Color3.fromRGB(255,255,255)
refreshBtn.Parent = mainFrame

local scroll = Instance.new("ScrollingFrame")
scroll.Name = "List"
scroll.Size = UDim2.new(1, -20, 1, -60)
scroll.Position = UDim2.new(0, 10, 0, 50)
scroll.BackgroundTransparency = 1
scroll.ScrollBarThickness = 8
scroll.CanvasSize = UDim2.new(0,0,0,0)
scroll.Parent = mainFrame
scroll.AutomaticCanvasSize = Enum.AutomaticSize.Y -- متاح في بعض الإصدارات، لكن نضبط يدوياً كمان

local uiList = Instance.new("UIListLayout")
uiList.Padding = UDim.new(0,6)
uiList.SortOrder = Enum.SortOrder.LayoutOrder
uiList.Parent = scroll

-- قوالب العناصر (Template)
local function createItemTemplate(nameText)
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(1, -10, 0, 32)
    btn.BackgroundTransparency = 0.12
    btn.BackgroundColor3 = Color3.fromRGB(20,20,20)
    btn.BorderSizePixel = 0
    btn.AutoButtonColor = true
    btn.Text = nameText
    btn.TextXAlignment = Enum.TextXAlignment.Left
    btn.TextWrapped = false
    btn.Font = Enum.Font.Gotham
    btn.TextColor3 = Color3.fromRGB(230,230,230)
    btn.Parent = scroll
    return btn
end

-- دالة لجمع أسماء RemoteEvent من كل مكان في اللعبة
local function findAllRemoteEvents()
    local found = {}
    -- نبحث في ReplicatedStorage عادة أول
    local toSearch = {game:GetService("ReplicatedStorage"), game}
    -- لو تبي تحصر في أماكن معينة اضفهم هنا
    local seen = {}
    for _, root in ipairs(toSearch) do
        for _, obj in ipairs(root:GetDescendants()) do
            if obj:IsA("RemoteEvent") then
                -- نتأكد ما نكرر الأسماء نفسها اذا موجودة في مكانين مختلفين
                local id = obj:GetFullName()
                if not seen[id] then
                    table.insert(found, {name = obj.Name, full = id, instance = obj})
                    seen[id] = true
                end
            end
        end
    end
    return found
end

-- تفرغ القائمة وتعرض النتائج
local function populateList()
    -- نمسح القديم
    for _, child in ipairs(scroll:GetChildren()) do
        if child:IsA("TextButton") then child:Destroy() end
    end

    local remotes = findAllRemoteEvents()
    if #remotes == 0 then
        local lbl = createItemTemplate("ما في RemoteEvents في اللعبة")
        lbl.Active = false
        lbl.Selectable = false
    else
        for i, info in ipairs(remotes) do
            local item = createItemTemplate(info.name)
            item.LayoutOrder = i
            -- لما تضغط على الاسم يطبع المسار الكامل في Output ويحدد الإنســـتنس
            item.MouseButton1Click:Connect(function()
                print(("RemoteEvent clicked -> Name: %s   FullPath: %s"):format(info.name, info.full))
                -- مثال: لو كنت صاحب اللعبة وتبي ترسل للسيرفر تقدر تستخدم:
                -- info.instance:FireServer("hello") -- لكن هذا يعمل فقط لو السيرفر يسمح
            end)
        end
    end

    -- ضبّط CanvasSize حسب المحتوى
    -- ننتظر قليلًا للتأكد إن UIListLayout حدّث الـ AbsoluteContentSize
    local function updateCanvas()
        scroll.CanvasSize = UDim2.new(0, 0, 0, uiList.AbsoluteContentSize.Y + 8)
    end
    updateCanvas()
    uiList:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(updateCanvas)
end

-- زر التحديث يدوياً
refreshBtn.MouseButton1Click:Connect(populateList)

-- تحديث عند أول تشغيل
populateList()

-- لو تبي تحديث تلقائي لما يتغير شيء في ReplicatedStorage أو اللعبة
-- نراقب التغييرات الأساسية ونحدّث القائمة (بعض الحركات قد تكون متكررة، فخليها بسيطة)
local debounce = false
local function scheduleRefresh()
    if debounce then return end
    debounce = true
    delay(0.3, function()
        populateList()
        debounce = false
    end)
end

-- راقب ReplicatedStorage و game تغيير الأبناء
local rs = game:GetService("ReplicatedStorage")
rs.DescendantAdded:Connect(scheduleRefresh)
rs.DescendantRemoving:Connect(scheduleRefresh)
game.DescendantAdded:Connect(scheduleRefresh)
game.DescendantRemoving:Connect(scheduleRefresh)

-- نهاية السكربت
