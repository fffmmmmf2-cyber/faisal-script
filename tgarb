local player = game.Players.LocalPlayer
local cam = workspace.CurrentCamera
local rs = game:GetService("RunService")
local TweenService = game:GetService("TweenService")

-- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¹Ø±Ø¶
local gui = Instance.new("ScreenGui", player:WaitForChild("PlayerGui"))
gui.Name = "ModelSelector"
gui.ResetOnSpawn = false

local nameLabel = Instance.new("TextLabel", gui)
nameLabel.Size = UDim2.new(0, 300, 0, 40)
nameLabel.Position = UDim2.new(1, -310, 0, 100)
nameLabel.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
nameLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
nameLabel.Font = Enum.Font.SourceSansBold
nameLabel.TextScaled = true
nameLabel.Text = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¯ÙŠÙ„ Ù‚Ø±ÙŠØ¨"

local selectButton = Instance.new("TextButton", gui)
selectButton.Size = UDim2.new(0, 120, 0, 40)
selectButton.Position = UDim2.new(1, -130, 0, 150)
selectButton.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
selectButton.TextColor3 = Color3.fromRGB(255, 255, 255)
selectButton.Font = Enum.Font.SourceSansBold
selectButton.TextScaled = true
selectButton.Text = "ØªØ­Ø¯ÙŠØ¯"

local cancelButton = Instance.new("TextButton", gui)
cancelButton.Size = UDim2.new(0, 120, 0, 40)
cancelButton.Position = UDim2.new(1, -130, 0, 200)
cancelButton.BackgroundColor3 = Color3.fromRGB(80, 80, 80)
cancelButton.TextColor3 = Color3.fromRGB(255, 255, 255)
cancelButton.Font = Enum.Font.SourceSansBold
cancelButton.TextScaled = true
cancelButton.Text = "Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ¯"
cancelButton.Visible = false

local selectedModel = nil
local fixedModel = false
local rainbowActive = false

------------------------------------------------
-- ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£Ù‚Ø±Ø¨ Ù…ÙˆØ¯ÙŠÙ„ Ø¨Ø¯Ù‚Ø© Ø¹Ø§Ù„ÙŠØ©
------------------------------------------------
local function getClosestModel()
	local closestModel = nil
	local closestDist = math.huge
	local camPos = cam.CFrame.Position

	for _, obj in ipairs(workspace:GetDescendants()) do
		if obj:IsA("Model") and obj ~= player.Character and obj:FindFirstChildWhichIsA("BasePart") then
			-- ØªØ¬Ø§Ù‡Ù„ Ø£Ø¯ÙˆØ§Øª ÙˆØ£Ø´ÙŠØ§Ø¡ ØºÙŠØ± Ù…ÙÙŠØ¯Ø©
			if not obj:IsDescendantOf(workspace.Terrain) and not obj:IsA("Tool") then
				for _, part in ipairs(obj:GetDescendants()) do
					if part:IsA("BasePart") then
						local dist = (part.Position - camPos).Magnitude
						if dist < closestDist and dist < 70 then
							closestDist = dist
							closestModel = obj
						end
					end
				end
			end
		end
	end

	return closestModel
end

------------------------------------------------
-- ğŸŸ¥ ØªÙ…ÙŠÙŠØ² Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„ Ø¨Ø¥Ø·Ø§Ø±
------------------------------------------------
local function highlightModel(model)
	for _, part in ipairs(model:GetDescendants()) do
		if part:IsA("BasePart") then
			local sel = Instance.new("SelectionBox")
			sel.Adornee = part
			sel.Color3 = Color3.fromRGB(255, 0, 0)
			sel.LineThickness = 0.05
			sel.Parent = part
		end
	end
end

local function removeHighlights(model)
	for _, part in ipairs(model:GetDescendants()) do
		if part:IsA("BasePart") then
			local sel = part:FindFirstChildOfClass("SelectionBox")
			if sel then sel:Destroy() end
		end
	end
end

------------------------------------------------
-- ğŸŒˆ ØªØ£Ø«ÙŠØ± Ø§Ù„Ø±ÙŠÙ†Ø¨Ùˆ
------------------------------------------------
local function startRainbow(model)
	rainbowActive = true
	task.spawn(function()
		local hue = 0
		while rainbowActive and model and model.Parent do
			hue = (hue + 0.002) % 1
			local rainbowColor = Color3.fromHSV(hue, 1, 1)
			for _, part in ipairs(model:GetDescendants()) do
				if part:IsA("BasePart") then
					TweenService:Create(part, TweenInfo.new(0.1, Enum.EasingStyle.Linear), {Color = rainbowColor}):Play()
				end
			end
			task.wait(0.03)
		end
	end)
end

local function stopRainbow(model)
	rainbowActive = false
	if model and model.Parent then
		for _, part in ipairs(model:GetDescendants()) do
			if part:IsA("BasePart") then
				part.Color = part.BrickColor.Color
			end
		end
	end
end

------------------------------------------------
-- ğŸ” Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªÙ…Ø±
------------------------------------------------
rs.RenderStepped:Connect(function()
	if fixedModel then return end
	local newModel = getClosestModel()

	if newModel ~= selectedModel then
		if selectedModel then
			removeHighlights(selectedModel)
		end
		selectedModel = newModel

		if newModel then
			nameLabel.Text = "Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„: " .. newModel.Name
			highlightModel(newModel)
		else
			nameLabel.Text = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¯ÙŠÙ„ Ù‚Ø±ÙŠØ¨"
		end
	end
end)

------------------------------------------------
-- ğŸ”˜ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
------------------------------------------------
selectButton.MouseButton1Click:Connect(function()
	if selectedModel then
		fixedModel = true
		selectButton.Visible = false
		cancelButton.Visible = true
		startRainbow(selectedModel)
	end
end)

cancelButton.MouseButton1Click:Connect(function()
	if selectedModel then
		stopRainbow(selectedModel)
		removeHighlights(selectedModel)
		fixedModel = false
		selectButton.Visible = true
		cancelButton.Visible = false
		nameLabel.Text = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¯ÙŠÙ„ Ù‚Ø±ÙŠØ¨"
		selectedModel = nil
	end
end)
