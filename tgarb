local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

local highlightFolder = Instance.new("Folder")
highlightFolder.Name = "PlayerHighlights"
highlightFolder.Parent = workspace

local highlights = {}
local currentTarget = nil
local lastPositions = {}
local stationaryTime = {}
local beams = {}

-- يعطي اللاعب Highlight إذا ناقص
local function getHighlight(char)
    if not char then return end
    if highlights[char] then return highlights[char] end

    local h = Instance.new("Highlight")
    h.FillTransparency = 0.3
    h.OutlineTransparency = 0
    h.Parent = highlightFolder
    highlights[char] = h

    return h
end

-- Beam بين الكاميرا ورأس اللاعب الأخضر
local function createBeam(char)
    if beams[char] then return beams[char] end
    if not LocalPlayer.Character or not LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then return end

    local startAttachment = Instance.new("Attachment", LocalPlayer.Character.HumanoidRootPart)
    startAttachment.Name = "BeamStart"

    local endAttachment = Instance.new("Attachment", char.Head)
    endAttachment.Name = "BeamEnd"

    local beam = Instance.new("Beam")
    beam.Attachment0 = startAttachment
    beam.Attachment1 = endAttachment
    beam.Width0 = 0.1
    beam.Width1 = 0.1
    beam.FaceCamera = true
    beam.Color = ColorSequence.new(Color3.fromRGB(0,255,0))
    beam.Enabled = false
    beam.Parent = char

    beams[char] = beam
    return beam
end

-- فحص الرؤية
local function isVisible(targetChar)
    if not (LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Head")) then return false end
    if not (targetChar and targetChar:FindFirstChild("Head")) then return false end

    local origin = LocalPlayer.Character.Head.Position
    local target = targetChar.Head.Position

    local params = RaycastParams.new()
    params.FilterType = Enum.RaycastFilterType.Blacklist
    params.FilterDescendantsInstances = {LocalPlayer.Character}

    local ray = workspace:Raycast(origin, target - origin, params)

    if not ray then return true end
    if ray.Instance and ray.Instance:IsDescendantOf(targetChar) then return true end

    return false
end

-- تحديث الألوان والخط
local function updateColors()
    for _, plr in ipairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer and plr.Character then
            local char = plr.Character
            local h = getHighlight(char)
            h.Adornee = char

            local beam = createBeam(char)

            if isVisible(char) then
                h.FillColor = Color3.fromRGB(0,255,0)
                h.OutlineColor = Color3.fromRGB(0,255,0)
                beam.Enabled = true
            else
                h.FillColor = Color3.fromRGB(255,0,0)
                h.OutlineColor = Color3.fromRGB(255,0,0)
                beam.Enabled = false
            end
        end
    end
end

-- كل 10 ثواني تحقق من كل اللاعبين وأضف Highlight إذا ناقص
task.spawn(function()
    while true do
        for _, plr in ipairs(Players:GetPlayers()) do
            if plr ~= LocalPlayer and plr.Character then
                getHighlight(plr.Character)
                createBeam(plr.Character)
            end
        end
        task.wait(10)
    end
end)

-- تتبع حركة اللاعبين لتحديد الوقوف
local function updatePlayerMovement()
    for _, plr in ipairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
            local hrp = plr.Character.HumanoidRootPart
            local lastPos = lastPositions[plr] or hrp.Position
            local dist = (hrp.Position - lastPos).Magnitude

            if dist < 0.1 then
                stationaryTime[plr] = (stationaryTime[plr] or 0) + 0.1
            else
                stationaryTime[plr] = 0
            end

            lastPositions[plr] = hrp.Position
        end
    end
end

-- اختيار أقرب لاعب أخضر متحرك فقط
local function updateTarget()
    local nearest = nil
    local nearestDist = math.huge
    if not (LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")) then return end
    local myPos = LocalPlayer.Character.HumanoidRootPart.Position

    for _, plr in ipairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer and plr.Character then
            local char = plr.Character
            local h = highlights[char]
            local stationary = stationaryTime[plr] or 0

            if h and h.FillColor == Color3.fromRGB(0,255,0) and stationary < 7 then
                local hrp = char:FindFirstChild("HumanoidRootPart")
                if hrp then
                    local dist = (hrp.Position - myPos).Magnitude
                    if dist < nearestDist then
                        nearestDist = dist
                        nearest = char
                    end
                end
            end
        end
    end

    currentTarget = nearest
end

-- الكاميرا مثبتة بقوة جدًا
RunService.RenderStepped:Connect(function()
    if currentTarget and currentTarget:FindFirstChild("Head") then
        Camera.CFrame = CFrame.new(Camera.CFrame.Position, currentTarget.Head.Position)
    end
end)

-- التحديثات
task.spawn(function()
    while true do
        updateColors()
        updatePlayerMovement()
        task.wait(0.1)
    end
end)

task.spawn(function()
    while true do
        updateTarget()
        task.wait(0.3)
    end
end)
