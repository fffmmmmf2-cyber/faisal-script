-- سكربت موحد للتجميد + تحميل GUI من GitHub
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Remote = ReplicatedStorage:WaitForChild("Event")

-- إعدادات
local FREEZE_PREFIX_LENGTH = 3
local ALLOWED_DEV_USERIDS = { game.CreatorId }
local frozen = {}

-- دوال الفريز وفك الفريز
local function freezePlayer(plr)
    if not plr.Character then return end
    local hum = plr.Character:FindFirstChildOfClass("Humanoid")
    local root = plr.Character:FindFirstChild("HumanoidRootPart")
    if hum and root then
        frozen[plr.UserId] = {WalkSpeed = hum.WalkSpeed, JumpPower = hum.JumpPower, Anchored = root.Anchored}
        hum.WalkSpeed = 0
        hum.JumpPower = 0
        hum.PlatformStand = true
        root.Anchored = true
    end
end

local function unfreezePlayer(plr)
    local data = frozen[plr.UserId]
    if not data or not plr.Character then return end
    local hum = plr.Character:FindFirstChildOfClass("Humanoid")
    local root = plr.Character:FindFirstChild("HumanoidRootPart")
    if hum and root then
        hum.WalkSpeed = data.WalkSpeed or 16
        hum.JumpPower = data.JumpPower or 50
        hum.PlatformStand = false
        root.Anchored = data.Anchored or false
    end
    frozen[plr.UserId] = nil
end

local function findPlayerByPrefix(prefix)
    prefix = string.lower(prefix)
    for _, p in ipairs(Players:GetPlayers()) do
        if string.sub(string.lower(p.Name),1,#prefix) == prefix then
            return p
        end
    end
end

local function hasPermission(player)
    local v = player:FindFirstChild("HasFreeze")
    return v and v:IsA("BoolValue") and v.Value == true
end

-- استقبال من GUI
Remote.OnServerEvent:Connect(function(sender,prefix)
    if not hasPermission(sender) then return end
    local target = findPlayerByPrefix(string.sub(prefix,1,FREEZE_PREFIX_LENGTH))
    if target and target ~= sender then
        freezePlayer(target)
    end
end)

-- أوامر شات للمطور
Players.PlayerAdded:Connect(function(p)
    p.Chatted:Connect(function(msg)
        local allowed = false
        for _, id in ipairs(ALLOWED_DEV_USERIDS) do
            if p.UserId == id then allowed = true break end
        end
        if not allowed then return end
        local lower = string.lower(msg)
        if string.sub(lower,1,9)=="/unfreeze " then
            local t=findPlayerByPrefix(string.sub(msg,10))
            if t then unfreezePlayer(t) end
        elseif string.sub(lower,1,10)=="/givefreeze" then
            local t=findPlayerByPrefix(string.sub(msg,11))
            if t then
                local b = t:FindFirstChild("HasFreeze")
                if not b then b=Instance.new("BoolValue") b.Name="HasFreeze" b.Parent=t end
                b.Value=true
            end
        elseif string.sub(lower,1,11)=="/removefreeze" then
            local t=findPlayerByPrefix(string.sub(msg,12))
            if t then
                local b = t:FindFirstChild("HasFreeze")
                if b then b:Destroy() end
            end
        end
    end)
end)

-- تحميل GUI من GitHub مباشرة باستخدام LoadString
local success, err = pcall(function()
    loadstring(game:HttpGet("https://raw.githubusercontent.com/fffmmmmf2-cyber/faisal-script/main/admin"))()
end)
if not success then warn("فشل تحميل GUI: "..tostring(err)) end

-- تنظيف عند خروج اللاعبين
Players.PlayerRemoving:Connect(function(p)
    frozen[p.UserId]=nil
end)
