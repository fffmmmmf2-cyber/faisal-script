-- LocalScript: Faisal Compact Vertical GUI (Local only)
-- ضع هذا السكربت في StarterPlayerScripts

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

-- ====== GUI صغير ومرتب ======
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "FaisalCompactGui"
screenGui.ResetOnSpawn = false
screenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")

local container = Instance.new("Frame")
container.Name = "Container"
container.Size = UDim2.new(0,92,0,240) -- ضيق وصغير
container.Position = UDim2.new(1,-100,0.5,-120) -- يمين منتصف الشاشة
container.AnchorPoint = Vector2.new(0,0)
container.BackgroundColor3 = Color3.fromRGB(0,0,0)
container.BackgroundTransparency = 0.5
container.BorderSizePixel = 0
container.Parent = screenGui
container.ClipsDescendants = true

local title = Instance.new("TextLabel")
title.Size = UDim2.new(1,0,0,28)
title.Position = UDim2.new(0,0,0,6)
title.BackgroundTransparency = 1
title.Text = "created by faisal"
title.TextColor3 = Color3.fromRGB(255,255,255)
title.TextScaled = true
title.Font = Enum.Font.GothamBold
title.Parent = container

local function makeBtn(offsetY, text)
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(1,-10,0,44) -- زر متوسط الحجم
    btn.Position = UDim2.new(0,5,0,offsetY)
    btn.BackgroundTransparency = 0.15
    btn.BackgroundColor3 = Color3.fromRGB(25,25,25)
    btn.BorderSizePixel = 0
    btn.Text = text.." : OFF"
    btn.TextColor3 = Color3.fromRGB(255,255,255)
    btn.TextScaled = true
    btn.Font = Enum.Font.ArialBold
    btn.Parent = container
    return btn
end

local espBtn = makeBtn(42, "ESP")
local aimBtn = makeBtn(96, "AIM (belly)")
local healthBtn = makeBtn(150, "HEALTH")

local note = Instance.new("TextLabel")
note.Size = UDim2.new(1,-10,0,36)
note.Position = UDim2.new(0,5,0,202)
note.BackgroundTransparency = 1
note.Text = "local only"
note.TextScaled = true
note.TextColor3 = Color3.fromRGB(200,200,200)
note.Font = Enum.Font.SourceSansItalic
note.Parent = container

-- ===== حالات التشغيل =====
local ESP_ENABLED = false
local AIM_ENABLED = false
local HEALTH_ENABLED = false

local function setBtnText(btn, label, state)
    btn.Text = label .. " : " .. (state and "ON" or "OFF")
end

-- ===== وظائف ESP =====
local function safeDestroy(inst)
    if inst and inst.Parent then
        pcall(function() inst:Destroy() end)
    end
end

local function createBillboard(player)
    if not player.Character then return end
    local humanoid = player.Character:FindFirstChildOfClass("Humanoid")
    local hrp = player.Character:FindFirstChild("HumanoidRootPart") or player.Character:FindFirstChild("UpperTorso") or player.Character:FindFirstChild("Torso")
    if not humanoid or not hrp then return end

    safeDestroy(player.Character:FindFirstChild("FC_Billboard"))
    local billboard = Instance.new("BillboardGui")
    billboard.Name = "FC_Billboard"
    billboard.Adornee = hrp
    billboard.Size = UDim2.new(0,140,0,36)
    billboard.StudsOffset = Vector3.new(0,3,0)
    billboard.AlwaysOnTop = true
    billboard.Parent = player.Character

    local nameLabel = Instance.new("TextLabel", billboard)
    nameLabel.Size = UDim2.new(1,0,0,18)
    nameLabel.Position = UDim2.new(0,0,0,0)
    nameLabel.BackgroundTransparency = 1
    nameLabel.Text = player.Name
    nameLabel.TextColor3 = Color3.fromRGB(255,120,120)
    nameLabel.TextScaled = true
    nameLabel.Font = Enum.Font.Gotham

    local barFrame = Instance.new("Frame", billboard)
    barFrame.Size = UDim2.new(1,0,0,14)
    barFrame.Position = UDim2.new(0,0,0,20)
    barFrame.BackgroundTransparency = 0.3
    barFrame.BackgroundColor3 = Color3.fromRGB(30,30,30)
    barFrame.BorderSizePixel = 0

    local healthBar = Instance.new("Frame", barFrame)
    healthBar.Name = "FC_HealthBar"
    healthBar.Size = UDim2.new(1,0,1,0)
    healthBar.BorderSizePixel = 0
    healthBar.BackgroundColor3 = Color3.fromRGB(0,200,0)

    humanoid:GetPropertyChangedSignal("Health"):Connect(function()
        local denom = (humanoid.MaxHealth > 0 and humanoid.MaxHealth) or 1
        healthBar.Size = UDim2.new(math.clamp(humanoid.Health / denom, 0, 1), 0, 1, 0)
    end)
end

local function createHighlight(player)
    if not player.Character then return end
    safeDestroy(player.Character:FindFirstChild("FC_Highlight"))
    local hl = Instance.new("Highlight")
    hl.Name = "FC_Highlight"
    hl.Adornee = player.Character
    hl.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
    hl.FillColor = Color3.fromRGB(255,80,80)
    hl.FillTransparency = 0
    hl.OutlineTransparency = 0.8
    hl.Parent = player.Character
end

-- ===== Health number (تحديث سريع) =====
local function createHealthNumber(player)
    if not player.Character then return end
    local humanoid = player.Character:FindFirstChildOfClass("Humanoid")
    local hrp = player.Character:FindFirstChild("HumanoidRootPart") or player.Character:FindFirstChild("UpperTorso") or player.Character:FindFirstChild("Torso")
    if not humanoid or not hrp then return end

    safeDestroy(player.Character:FindFirstChild("FC_HealthNumber"))
    local billboard = Instance.new("BillboardGui")
    billboard.Name = "FC_HealthNumber"
    billboard.Adornee = hrp
    billboard.Size = UDim2.new(0,72,0,18)
    billboard.StudsOffset = Vector3.new(0,2,0)
    billboard.AlwaysOnTop = true
    billboard.Parent = player.Character

    local label = Instance.new("TextLabel", billboard)
    label.Size = UDim2.new(1,0,1,0)
    label.BackgroundTransparency = 1
    label.TextScaled = true
    label.Font = Enum.Font.GothamBold
    label.TextColor3 = Color3.fromRGB(230,230,230)

    spawn(function()
        while HEALTH_ENABLED and humanoid.Parent do
            if humanoid.Health <= 0 then
                label.Visible = false
            else
                label.Visible = true
                label.Text = string.format("%d/%d", math.floor(humanoid.Health), math.floor(humanoid.MaxHealth))
            end
            wait(0.05)
        end
        safeDestroy(billboard)
    end)
end

-- ===== تطبيق على كل لاعب =====
local function applyToPlayer(player)
    if player == LocalPlayer then return end
    local function onChar(char)
        if ESP_ENABLED then
            createHighlight(player)
            createBillboard(player)
        end
        if HEALTH_ENABLED then
            createHealthNumber(player)
        end
        local humanoid = char:FindFirstChildOfClass("Humanoid")
        if humanoid then
            humanoid.Died:Connect(function()
                safeDestroy(char:FindFirstChild("FC_HealthNumber"))
                safeDestroy(char:FindFirstChild("FC_Billboard"))
                safeDestroy(char:FindFirstChild("FC_Highlight"))
            end)
        end
    end
    if player.Character then onChar(player.Character) end
    player.CharacterAdded:Connect(onChar)
end

for _,p in pairs(Players:GetPlayers()) do applyToPlayer(p) end
Players.PlayerAdded:Connect(function(p) applyToPlayer(p) end)
Players.PlayerRemoving:Connect(function(p)
    if p.Character then
        safeDestroy(p.Character:FindFirstChild("FC_HealthNumber"))
        safeDestroy(p.Character:FindFirstChild("FC_Billboard"))
        safeDestroy(p.Character:FindFirstChild("FC_Highlight"))
    end
end)

-- ===== أزرار التفعيل =====
espBtn.MouseButton1Click:Connect(function()
    ESP_ENABLED = not ESP_ENABLED
    setBtnText(espBtn, "ESP", ESP_ENABLED)
    if ESP_ENABLED then
        for _,p in pairs(Players:GetPlayers()) do
            if p ~= LocalPlayer and p.Character then
                createHighlight(p)
                createBillboard(p)
            end
        end
    else
        for _,p in pairs(Players:GetPlayers()) do
            if p.Character then
                safeDestroy(p.Character:FindFirstChild("FC_Highlight"))
                safeDestroy(p.Character:FindFirstChild("FC_Billboard"))
            end
        end
    end
end)

healthBtn.MouseButton1Click:Connect(function()
    HEALTH_ENABLED = not HEALTH_ENABLED
    setBtnText(healthBtn, "HEALTH", HEALTH_ENABLED)
    if HEALTH_ENABLED then
        for _,p in pairs(Players:GetPlayers()) do
            if p ~= LocalPlayer and p.Character then
                createHealthNumber(p)
            end
        end
    else
        for _,p in pairs(Players:GetPlayers()) do
            if p.Character then safeDestroy(p.Character:FindFirstChild("FC_HealthNumber")) end
        end
    end
end)

-- ===== Aimbot ثابت على البطن =====
local currentTarget = nil
local findRate = 0.5
local lastFind = 0
local savedCamType = Camera.CameraType
local savedCamSubject = Camera.CameraSubject

local function findNearest()
    local myChar = LocalPlayer.Character
    if not myChar then return nil end
    local myHRP = myChar:FindFirstChild("HumanoidRootPart") or myChar:FindFirstChild("UpperTorso") or myChar:FindFirstChild("Torso")
    if not myHRP then return nil end
    local best, bestD = nil, math.huge
    for _,p in pairs(Players:GetPlayers()) do
        if p ~= LocalPlayer and p.Character and p.Character.Parent then
            local hrp = p.Character:FindFirstChild("HumanoidRootPart") or p.Character:FindFirstChild("UpperTorso") or p.Character:FindFirstChild("Torso")
            local hum = p.Character:FindFirstChildOfClass("Humanoid")
            if hrp and hum and hum.Health > 0 then
                local d = (hrp.Position - myHRP.Position).Magnitude
                if d < bestD then best, bestD = p, d end
            end
        end
    end
    return best
end

-- تحديث الكاميرا كل RenderStepped بحيث تبقى ثابتة على بطن الهدف
RunService.RenderStepped:Connect(function()
    if AIM_ENABLED and currentTarget and currentTarget.Character and currentTarget.Character.Parent then
        local hrp = currentTarget.Character:FindFirstChild("HumanoidRootPart") or currentTarget.Character:FindFirstChild("UpperTorso") or currentTarget.Character:FindFirstChild("Torso")
        if hrp then
            local targetPos = hrp.Position
            local camOffset = Vector3.new(0, 1.2, 6) -- تعديل المسافة والارتفاع لو تبي
            local camPos = targetPos + camOffset
            local lookAt = targetPos + Vector3.new(0, 0.6, 0)
            Camera.CFrame = CFrame.new(camPos, lookAt)
            Camera.CameraType = Enum.CameraType.Scriptable
        end
    end
end)

-- تجديد الهدف كل 0.5 ثانية (أقرب لاعب)
spawn(function()
    while true do
        if AIM_ENABLED then
            if tick() - lastFind >= findRate then
                lastFind = tick()
                currentTarget = findNearest()
            end
        else
            currentTarget = nil
        end
        wait(0.2)
    end
end)

aimBtn.MouseButton1Click:Connect(function()
    AIM_ENABLED = not AIM_ENABLED
    setBtnText(aimBtn, "AIM (belly)", AIM_ENABLED)
    if AIM_ENABLED then
        savedCamType = Camera.CameraType
        savedCamSubject = Camera.CameraSubject
    else
        pcall(function()
            Camera.CameraType = Enum.CameraType.Custom
            if LocalPlayer.Character then
                Camera.CameraSubject = LocalPlayer.Character:FindFirstChildOfClass("Humanoid") or savedCamSubject
            else
                Camera.CameraSubject = savedCamSubject
            end
        end)
        currentTarget = nil
    end
end)

-- تأكد من استرجاع الكاميرا عند سباون
LocalPlayer.CharacterAdded:Connect(function(char)
    wait(0.1)
    if not AIM_ENABLED then
        pcall(function()
            Camera.CameraType = Enum.CameraType.Custom
            Camera.CameraSubject = char:FindFirstChildOfClass("Humanoid") or Camera.CameraSubject
        end)
    end
end)

-- انتهى السكربت
