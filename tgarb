-- Server-side single Script (ضعه في ServerScriptService)
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")

-- إنشاء DuplicateEvent في ReplicatedStorage لو ما كان موجود
local duplicateEvent = ReplicatedStorage:FindFirstChild("DuplicateEvent")
if not duplicateEvent then
    duplicateEvent = Instance.new("RemoteEvent")
    duplicateEvent.Name = "DuplicateEvent"
    duplicateEvent.Parent = ReplicatedStorage
end

-- جدول لتخزين آخر وقت تدبيل لكل لاعب (كولداون)
local lastDupTime = {}
local COOLDOWN = 2 -- ثواني

-- معالج على السيرفر للتدبيل
duplicateEvent.OnServerEvent:Connect(function(player)
    if not player or not player.Parent then return end

    -- كولداون بسيط
    local now = tick()
    if lastDupTime[player.UserId] and now - lastDupTime[player.UserId] < COOLDOWN then
        return
    end
    lastDupTime[player.UserId] = now

    -- تأكد من أنّ اللاعب عنده شخصية
    local char = player.Character
    if not char then return end

    -- ابحث عن أداة (Tool) في الشخصية أو في الحقيبة
    local tool = char:FindFirstChildOfClass("Tool") or player.Backpack:FindFirstChildOfClass("Tool")
    if not tool then
        -- ما فيه أداة للتكرار
        -- (اختياري) ترجع رسالة للاعب عبر RemoteEvent اخر لو حبيت
        return
    end

    -- استنساخ الأداة ووضعها في الحقيبة
    local cloned = tool:Clone()
    cloned.Parent = player.Backpack

    warn(("Player %s duplicated tool %s"):format(player.Name, tool.Name))
end)

-- دالة تساعد بصنع GUI وLocalScript لكل لاعب
local function givePlayerGui(player)
    local playerGui = player:WaitForChild("PlayerGui")

    -- ScreenGui
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "DupGui"
    screenGui.ResetOnSpawn = false
    screenGui.Parent = playerGui

    -- TextButton
    local button = Instance.new("TextButton")
    button.Name = "DupButton"
    button.Size = UDim2.new(0, 220, 0, 50)
    button.Position = UDim2.new(0.5, -110, 0.85, 0)
    button.AnchorPoint = Vector2.new(0.5, 0)
    button.Text = "تدبيل الأداة"
    button.TextScaled = true
    button.BackgroundColor3 = Color3.fromRGB(50,150,50)
    button.TextColor3 = Color3.new(1,1,1)
    button.Parent = screenGui

    -- Status label
    local status = Instance.new("TextLabel")
    status.Name = "DupStatus"
    status.Size = UDim2.new(0, 320, 0, 30)
    status.Position = UDim2.new(0.5, -160, 0.80, 0)
    status.AnchorPoint = Vector2.new(0.5, 0)
    status.BackgroundTransparency = 1
    status.TextScaled = true
    status.Text = ""
    status.Parent = screenGui

    -- LocalScript source (سيشتغل على جهاز اللاعب)
    local localSource = [[
        local ReplicatedStorage = game:GetService("ReplicatedStorage")
        local player = game.Players.LocalPlayer
        local screenGui = script.Parent
        local button = screenGui:WaitForChild("DupButton")
        local status = screenGui:WaitForChild("DupStatus")
        local duplicateEvent = ReplicatedStorage:WaitForChild("DuplicateEvent")

        -- عند الضغط على الزر نرسل طلب للسيرفر
        button.MouseButton1Click:Connect(function()
            status.Text = "جارٍ الطلب..."
            -- حاوية pcall لمنع أخطاء على العميل
            local ok, err = pcall(function()
                duplicateEvent:FireServer()
            end)
            if not ok then
                status.Text = "فشل الإرسال"
                warn("Failed to FireServer DuplicateEvent: "..tostring(err))
                return
            end
            -- نعرض رسالة مؤقتة (السيرفر ينسخ فعليًا)
            status.Text = "طلب الإنسخ مرسل"
            wait(1.5)
            status.Text = ""
        end)
    ]]

    -- نخلق LocalScript ونضع الكود داخله
    local localScript = Instance.new("LocalScript")
    localScript.Name = "DupLocal"
    localScript.Source = localSource
    localScript.Parent = screenGui
end

-- عند دخول لاعب نعطيه ال GUI
Players.PlayerAdded:Connect(function(player)
    givePlayerGui(player)
end)

-- للاعبين الموجودين بالفعل (لو ريستارت السكربت)
for _, pl in pairs(Players:GetPlayers()) do
    -- تأكد اللاعب عنده PlayerGui جاهز
    if pl.Parent then
        givePlayerGui(pl)
    end
end
