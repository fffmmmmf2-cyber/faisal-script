--!strict
-- Pet Script Viewer (Studio Plugin) - FULL
-- يشغل فقط داخل Roblox Studio كبلجن. يقرأ Script.Source ويعرضه.

-- =======================
-- 1) تهيئة البلجن وواجهة Dock
-- =======================
local toolbar = plugin:CreateToolbar("Pet Tools")
local button = toolbar:CreateButton("PetViewer", "Open Pet Script Viewer", "rbxassetid://4458901886")
button.ClickableWhenViewportHidden = true

local info = DockWidgetPluginGuiInfo.new(
	Enum.InitialDockState.Left, -- dock
	true,  -- initial enabled
	false, -- override previous size
	480,   -- min width
	520,   -- min height
	320,   -- initial width
	520    -- initial height
)

local dock = plugin:CreateDockWidgetPluginGui("PetScriptViewerDock", info)
dock.Title = "Pet Script Viewer (Studio)"

-- امسح كل شيء قديم
for _, c in ipairs(dock:GetChildren()) do c:Destroy() end

-- خلفية
local Background = Instance.new("Frame")
Background.Size = UDim2.fromScale(1, 1)
Background.BackgroundColor3 = Color3.fromRGB(24, 24, 24)
Background.BorderSizePixel = 0
Background.Parent = dock

-- رأس
local Header = Instance.new("Frame")
Header.Size = UDim2.new(1, 0, 0, 44)
Header.BackgroundColor3 = Color3.fromRGB(32, 32, 32)
Header.BorderSizePixel = 0
Header.Parent = Background

local Title = Instance.new("TextLabel")
Title.BackgroundTransparency = 1
Title.Size = UDim2.new(1, -20, 1, 0)
Title.Position = UDim2.new(0, 10, 0, 0)
Title.Font = Enum.Font.SourceSansSemibold
Title.TextSize = 20
Title.TextXAlignment = Enum.TextXAlignment.Left
Title.TextColor3 = Color3.fromRGB(255,255,255)
Title.Text = "Pet Script Viewer — Studio"
Title.Parent = Header

-- تقسيم أفقي: يسار قائمة، يمين معاينة
local Main = Instance.new("Frame")
Main.Size = UDim2.new(1, 0, 1, -44)
Main.Position = UDim2.new(0, 0, 0, 44)
Main.BackgroundTransparency = 1
Main.Parent = Background

local ListPanel = Instance.new("Frame")
ListPanel.Size = UDim2.new(0.45, -6, 1, -10)
ListPanel.Position = UDim2.new(0, 6, 0, 5)
ListPanel.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
ListPanel.Parent = Main

local lpCorner = Instance.new("UICorner")
lpCorner.CornerRadius = UDim.new(0, 8)
lpCorner.Parent = ListPanel

local PreviewPanel = Instance.new("Frame")
PreviewPanel.Size = UDim2.new(0.55, -6, 1, -10)
PreviewPanel.Position = UDim2.new(0.45, 6, 0, 5)
PreviewPanel.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
PreviewPanel.Parent = Main

local ppCorner = Instance.new("UICorner")
ppCorner.CornerRadius = UDim.new(0, 8)
ppCorner.Parent = PreviewPanel

-- عنوان المعاينة + زر فتح السكربت في الاستوديو
local PreviewHeader = Instance.new("Frame")
PreviewHeader.Size = UDim2.new(1, 0, 0, 40)
PreviewHeader.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
PreviewHeader.BorderSizePixel = 0
PreviewHeader.Parent = PreviewPanel

local PreviewTitle = Instance.new("TextLabel")
PreviewTitle.BackgroundTransparency = 1
PreviewTitle.Size = UDim2.new(1, -130, 1, 0)
PreviewTitle.Position = UDim2.new(0, 10, 0, 0)
PreviewTitle.Font = Enum.Font.SourceSansSemibold
PreviewTitle.TextSize = 18
PreviewTitle.TextXAlignment = Enum.TextXAlignment.Left
PreviewTitle.TextColor3 = Color3.fromRGB(255,255,255)
PreviewTitle.Text = "Preview"
PreviewTitle.Parent = PreviewHeader

local OpenInStudio = Instance.new("TextButton")
OpenInStudio.Size = UDim2.fromOffset(120, 26)
OpenInStudio.Position = UDim2.new(1, -130, 0.5, -13)
OpenInStudio.Text = "Open Script"
OpenInStudio.Font = Enum.Font.SourceSansSemibold
OpenInStudio.TextSize = 16
OpenInStudio.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
OpenInStudio.TextColor3 = Color3.fromRGB(255, 255, 255)
OpenInStudio.Parent = PreviewHeader

local OpenCorner = Instance.new("UICorner")
OpenCorner.CornerRadius = UDim.new(0, 6)
OpenCorner.Parent = OpenInStudio

-- سكرول + تكست للمعاينة
local CodeScroll = Instance.new("ScrollingFrame")
CodeScroll.Size = UDim2.new(1, -12, 1, -52)
CodeScroll.Position = UDim2.new(0, 6, 0, 46)
CodeScroll.BackgroundTransparency = 1
CodeScroll.ScrollBarThickness = 8
CodeScroll.CanvasSize = UDim2.new()
CodeScroll.Parent = PreviewPanel

local CodeText = Instance.new("TextBox")
CodeText.BackgroundTransparency = 1
CodeText.Size = UDim2.new(1, -10, 0, 400)
CodeText.Position = UDim2.new(0, 5, 0, 0)
CodeText.TextXAlignment = Enum.TextXAlignment.Left
CodeText.TextYAlignment = Enum.TextYAlignment.Top
CodeText.TextWrapped = false
CodeText.ClearTextOnFocus = false
CodeText.MultiLine = true
CodeText.Font = Enum.Font.Code
CodeText.TextColor3 = Color3.fromRGB(230, 230, 230)
CodeText.TextSize = 16
CodeText.TextEditable = false -- منع الكتابة
CodeText.Parent = CodeScroll

local SelectedObject: LuaSourceContainer? = nil

local function resizeCodeHeight()
	local text = CodeText.Text or ""
	local lines = 1
	for _ in string.gmatch(text, "\n") do
		lines += 1
	end
	local lineHeight = CodeText.TextSize + 6
	local h = math.max(lines * lineHeight + 10, 200)
	CodeText.Size = UDim2.new(1, -10, 0, h)
	CodeScroll.CanvasSize = UDim2.new(0, 0, 0, h + 20)
end
CodeText:GetPropertyChangedSignal("Text"):Connect(resizeCodeHeight)

OpenInStudio.MouseButton1Click:Connect(function()
	if SelectedObject and SelectedObject.Parent then
		-- اختَر العنصر في الاكسبلورر وافتحه
		game.Selection:Set({SelectedObject})
		-- Studio سيفتح التبويب تلقائيًا عند التحديد في أغلب الحالات
	end
end)

-- =======================
-- 2) قائمة النتائج (يسار)
-- =======================
local SearchHeader = Instance.new("TextLabel")
SearchHeader.BackgroundTransparency = 1
SearchHeader.Size = UDim2.new(1, -12, 0, 30)
SearchHeader.Position = UDim2.new(0, 6, 0, 6)
SearchHeader.Font = Enum.Font.SourceSansSemibold
SearchHeader.TextSize = 18
SearchHeader.TextXAlignment = Enum.TextXAlignment.Left
SearchHeader.TextColor3 = Color3.fromRGB(255,255,255)
SearchHeader.Text = "Scripts containing 'Pet' (name or source)"
SearchHeader.Parent = ListPanel

local ListScroll = Instance.new("ScrollingFrame")
ListScroll.Size = UDim2.new(1, -12, 1, -46)
ListScroll.Position = UDim2.new(0, 6, 0, 40)
ListScroll.BackgroundTransparency = 1
ListScroll.ScrollBarThickness = 8
ListScroll.CanvasSize = UDim2.new()
ListScroll.Parent = ListPanel

local Layout = Instance.new("UIListLayout")
Layout.SortOrder = Enum.SortOrder.LayoutOrder
Layout.Padding = UDim.new(0, 6)
Layout.Parent = ListScroll

Layout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
	ListScroll.CanvasSize = UDim2.new(0, 0, 0, Layout.AbsoluteContentSize.Y + 20)
end)

local function safeGetSource(obj: Instance): (string?, boolean)
	local ok, src = pcall(function()
		return (obj :: any).Source
	end)
	if ok and typeof(src) == "string" and #src > 0 then
		return src, true
	end
	return nil, false
end

local function looksLikePet(s: string?): boolean
	return s ~= nil and (string.find(s, "[Pp][Ee][Tt]") ~= nil)
end

local function addRow(obj: LuaSourceContainer, readable: boolean)
	local row = Instance.new("TextButton")
	row.Size = UDim2.new(1, 0, 0, 34)
	row.Text = obj:GetFullName()
	row.TextScaled = true
	row.TextColor3 = Color3.fromRGB(255,255,255)
	row.AutoButtonColor = true
	row.Parent = ListScroll

	local stroke = Instance.new("UIStroke")
	stroke.Thickness = 1.2
	stroke.Transparency = 0.3
	stroke.Color = Color3.fromRGB(255,255,255)
	stroke.Parent = row

	local corner = Instance.new("UICorner")
	corner.CornerRadius = UDim.new(0, 6)
	corner.Parent = row

	-- أزرق لو نقدر نقرأ، أحمر لو لا
	if readable then
		row.BackgroundColor3 = Color3.fromRGB(20, 120, 255)
	else
		row.BackgroundColor3 = Color3.fromRGB(220, 60, 60)
	end

	row.MouseButton1Click:Connect(function()
		SelectedObject = obj
		PreviewTitle.Text = obj:GetFullName()
		local src, can = safeGetSource(obj)
		if can and src then
			CodeText.Text = src
		else
			CodeText.Text = "-- لا يمكن عرض الكود لهذا السكربت."
		end
		resizeCodeHeight()
	end)
end

local function scan()
	-- نظّف القائمة
	for _, c in ipairs(ListScroll:GetChildren()) do
		if c:IsA("GuiObject") then c:Destroy() end
	end

	-- ابحث في كل اللعبة (Studio يسمح بالوصول)
	local descendants = game:GetDescendants()
	table.sort(descendants, function(a, b)
		return a:GetFullName():lower() < b:GetFullName():lower()
	end)

	local foundCount = 0
	for _, obj in ipairs(descendants) do
		if obj:IsA("ModuleScript") or obj:IsA("LocalScript") or obj:IsA("Script") then
			local isPet = looksLikePet(obj.Name)
			local readNow = false

			if not isPet then
				local src = select(1, safeGetSource(obj))
				if src and looksLikePet(src) then
					isPet = true
					readNow = true
				end
			else
				-- إن كان الاسم يطابق، نحاول معرفة قابلية القراءة لتلوين الزر بدقة
				local _, can = safeGetSource(obj)
				readNow = can
			end

			if isPet then
				foundCount += 1
				addRow(obj :: LuaSourceContainer, readNow)
			end
		end
	end

	if foundCount == 0 then
		local empty = Instance.new("TextLabel")
		empty.Size = UDim2.new(1, 0, 0, 40)
		empty.BackgroundTransparency = 1
		empty.Text = "لا توجد سكربتات تحتوي 'Pet'."
		empty.TextColor3 = Color3.fromRGB(255,255,255)
		empty.TextScaled = true
		empty.Parent = ListScroll
	end
end

button.Click:Connect(function()
	dock.Enabled = true
	scan()
end)

-- افتح تلقائي أول مرة
dock.Enabled = true
scan()
