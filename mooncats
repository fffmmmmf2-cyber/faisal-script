-- Pet Script Viewer (LocalScript)
-- ضع هذا الملف داخل StarterPlayer > StarterPlayerScripts أو داخل StarterGui ثم شغّل اللعب (Play, F5)

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local StarterPlayer = game:GetService("StarterPlayer")
local StarterGui = game:GetService("StarterGui")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer
if not player then
    warn("[PetViewer] هذا السكربت يجب أن يكون LocalScript ويعمل أثناء Play (F5).")
    return
end

local playerGui = player:WaitForChild("PlayerGui")

-- امسح أي نسخة قديمة من الواجهة
do
    local old = playerGui:FindFirstChild("PetScriptViewer")
    if old then old:Destroy() end
end

-- ========== بناء الواجهة ==========
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "PetScriptViewer"
ScreenGui.ResetOnSpawn = false
ScreenGui.IgnoreGuiInset = true
ScreenGui.Parent = playerGui

local Background = Instance.new("Frame")
Background.Size = UDim2.fromScale(1,1)
Background.Position = UDim2.fromScale(0,0)
Background.BackgroundColor3 = Color3.fromRGB(18,18,18)
Background.BackgroundTransparency = 0.12
Background.Parent = ScreenGui

-- Header
local Header = Instance.new("Frame")
Header.Size = UDim2.new(1,0,0,44)
Header.Position = UDim2.new(0,0,0,0)
Header.BackgroundColor3 = Color3.fromRGB(28,28,28)
Header.Parent = Background

local HeaderLabel = Instance.new("TextLabel")
HeaderLabel.Size = UDim2.new(1,-20,1,0)
HeaderLabel.Position = UDim2.new(0,10,0,0)
HeaderLabel.BackgroundTransparency = 1
HeaderLabel.Font = Enum.Font.SourceSansSemibold
HeaderLabel.TextSize = 18
HeaderLabel.TextColor3 = Color3.fromRGB(255,255,255)
HeaderLabel.TextXAlignment = Enum.TextXAlignment.Left
HeaderLabel.Text = "Pet Script Viewer — عرض السكربتات التي تحتوي Pet"
HeaderLabel.Parent = Header

-- ScrollFrame للقائمة
local Scroll = Instance.new("ScrollingFrame")
Scroll.Size = UDim2.new(1,0,1,-44)
Scroll.Position = UDim2.new(0,0,0,44)
Scroll.CanvasSize = UDim2.new(0,0,0,0)
Scroll.ScrollBarThickness = 10
Scroll.BackgroundTransparency = 1
Scroll.Parent = Background

local UIListLayout = Instance.new("UIListLayout")
UIListLayout.Parent = Scroll
UIListLayout.SortOrder = Enum.SortOrder.LayoutOrder
UIListLayout.Padding = UDim.new(0,6)

UIListLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
    Scroll.CanvasSize = UDim2.new(0,0,0,UIListLayout.AbsoluteContentSize.Y + 20)
end)

-- Preview frame (يظهر عندما تضغط على سكربت)
local Preview = Instance.new("Frame")
Preview.Size = UDim2.new(0.92,0,0.9,0)
Preview.Position = UDim2.new(0.04,0,0.05,0)
Preview.BackgroundColor3 = Color3.fromRGB(26,26,26)
Preview.Visible = false
Preview.Parent = Background

local PrevHeader = Instance.new("Frame")
PrevHeader.Size = UDim2.new(1,0,0,44)
PrevHeader.BackgroundColor3 = Color3.fromRGB(36,36,36)
PrevHeader.Parent = Preview

local PrevTitle = Instance.new("TextLabel")
PrevTitle.Size = UDim2.new(1,-120,1,0)
PrevTitle.Position = UDim2.new(0,10,0,0)
PrevTitle.BackgroundTransparency = 1
PrevTitle.Font = Enum.Font.SourceSansSemibold
PrevTitle.TextSize = 18
PrevTitle.TextColor3 = Color3.fromRGB(255,255,255)
PrevTitle.TextXAlignment = Enum.TextXAlignment.Left
PrevTitle.Text = "Preview"
PrevTitle.Parent = PrevHeader

local BackBtn = Instance.new("TextButton")
BackBtn.Size = UDim2.new(0,100,0,32)
BackBtn.Position = UDim2.new(1,-110,0.5,-16)
BackBtn.Text = "رجوع"
BackBtn.Font = Enum.Font.SourceSansSemibold
BackBtn.TextSize = 16
BackBtn.BackgroundColor3 = Color3.fromRGB(70,70,70)
BackBtn.TextColor3 = Color3.fromRGB(255,255,255)
BackBtn.Parent = PrevHeader

BackBtn.MouseButton1Click:Connect(function()
    Preview.Visible = false
end)

local CodeScroll = Instance.new("ScrollingFrame")
CodeScroll.Size = UDim2.new(1,-20,1,-60)
CodeScroll.Position = UDim2.new(0,10,0,50)
CodeScroll.BackgroundTransparency = 1
CodeScroll.ScrollBarThickness = 8
CodeScroll.Parent = Preview

local CodeBox = Instance.new("TextBox")
CodeBox.Size = UDim2.new(1,-10,0,400)
CodeBox.Position = UDim2.new(0,5,0,0)
CodeBox.BackgroundTransparency = 1
CodeBox.TextXAlignment = Enum.TextXAlignment.Left
CodeBox.TextYAlignment = Enum.TextYAlignment.Top
CodeBox.ClearTextOnFocus = false
CodeBox.MultiLine = true
CodeBox.Font = Enum.Font.Code
CodeBox.TextSize = 16
CodeBox.TextColor3 = Color3.fromRGB(230,230,230)
CodeBox.TextEditable = false
CodeBox.Parent = CodeScroll

local function resizeCode()
    local txt = CodeBox.Text or ""
    local lines = 1
    for _ in string.gmatch(txt, "\n") do lines = lines + 1 end
    local lineH = CodeBox.TextSize + 6
    local h = math.max(lines * lineH + 10, 200)
    CodeBox.Size = UDim2.new(1,-10,0,h)
    CodeScroll.CanvasSize = UDim2.new(0,0,0,h + 20)
end
CodeBox:GetPropertyChangedSignal("Text"):Connect(resizeCode)

-- ======= دوال مساعدة =======
local function safeGetSource(obj)
    local ok, src = pcall(function()
        return (obj :: any).Source
    end)
    if ok and type(src) == "string" and #src > 0 then
        return src, true
    end
    return nil, false
end

local function looksLikePet(s)
    return s and string.find(s, "[Pp][Ee][Tt]")
end

-- الحاويات التي نفحصها (العميل يمكنه الوصول اليها عادة)
local containers = {
    workspace,
    ReplicatedStorage,
    player:WaitForChild("PlayerScripts"),
    StarterPlayer:WaitForChild("StarterPlayerScripts"),
    StarterGui
}

-- تنظيف قائمة النتائج
local function clearList()
    for _, child in ipairs(Scroll:GetChildren()) do
        if child:IsA("TextButton") or child:IsA("TextLabel") then
            child:Destroy()
        end
    end
end

-- بناء القائمة
local function buildList()
    clearList()
    local found = {}

    for _, container in ipairs(containers) do
        local ok, descendants = pcall(function() return container:GetDescendants() end)
        if ok and descendants then
            for _, obj in ipairs(descendants) do
                if obj:IsA("ModuleScript") or obj:IsA("LocalScript") or obj:IsA("Script") then
                    local isP = looksLikePet(obj.Name)
                    if not isP then
                        local src = select(1, safeGetSource(obj))
                        if src and looksLikePet(src) then isP = true end
                    end
                    if isP then table.insert(found, obj) end
                end
            end
        end
    end

    table.sort(found, function(a,b) return a:GetFullName():lower() < b:GetFullName():lower() end)

    if #found == 0 then
        local lbl = Instance.new("TextLabel")
        lbl.Size = UDim2.new(1,-20,0,40)
        lbl.Position = UDim2.new(0,10,0,0)
        lbl.BackgroundTransparency = 1
        lbl.Text = "لا توجد سكربتات تحتوي 'Pet' ضمن الوصول الحالي."
        lbl.TextColor3 = Color3.fromRGB(255,255,255)
        lbl.TextScaled = true
        lbl.Parent = Scroll
        return
    end

    for i, obj in ipairs(found) do
        local btn = Instance.new("TextButton")
        btn.Size = UDim2.new(1,-20,0,36)
        btn.LayoutOrder = i
        btn.Text = obj:GetFullName()
        btn.TextColor3 = Color3.fromRGB(255,255,255)
        btn.TextScaled = true
        btn.AutoButtonColor = true
        btn.Parent = Scroll

        local stroke = Instance.new("UIStroke")
        stroke.Thickness = 1
        stroke.Transparency = 0.3
        stroke.Color = Color3.fromRGB(0,0,0)
        stroke.Parent = btn

        local corner = Instance.new("UICorner")
        corner.CornerRadius = UDim.new(0,6)
        corner.Parent = btn

        -- تلوين: أزرق لو نقدر نقرأ، أحمر لو ما نقدر
        local src, readable = safeGetSource(obj)
        if readable and src then
            btn.BackgroundColor3 = Color3.fromRGB(20,120,255) -- أزرق
        else
            btn.BackgroundColor3 = Color3.fromRGB(220,60,60)  -- أحمر
        end

        btn.MouseButton1Click:Connect(function()
            Preview.Visible = true
            if readable and src then
                CodeBox.Text = src
            else
                CodeBox.Text = "-- هذا السكربت محمي ولا يمكن قراءة الكود من جهة العميل (Client)."
            end
            resizeCode()
        end)
    end
end

-- بناء القائمة أول مرة
buildList()

-- حدث تحديث تلقائي عند إضافة/حذف descendants داخل الحاويات (حتى لو أضفت سكربت جديد أثناء Play)
for _, container in ipairs(containers) do
    pcall(function()
        container.DescendantAdded:Connect(function()
            task.wait(0.08)
            buildList()
        end)
        container.DescendantRemoving:Connect(function()
            task.wait(0.08)
            buildList()
        end)
    end)
end

-- طباعة مساعدة في الـ Output
print("[PetViewer] جاهز. افتح Output (F9) لو فيه أي أخطاء.")
