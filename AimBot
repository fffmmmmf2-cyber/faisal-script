--// Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera
local Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
local Humanoid = Character:WaitForChild("Humanoid")
local RootPart = Character:WaitForChild("HumanoidRootPart")

-- Variables
local targetPartName = "HumanoidRootPart"
local trackingEnabled = false

-- GUI
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.ResetOnSpawn = false
ScreenGui.Parent = game:GetService("CoreGui")

local MainFrame = Instance.new("Frame")
MainFrame.Size = UDim2.new(0,200,0,100)
MainFrame.Position = UDim2.new(0.3,0,0.3,0)
MainFrame.BackgroundColor3 = Color3.fromRGB(50,50,50)
MainFrame.Active = true
MainFrame.Draggable = true
MainFrame.Parent = ScreenGui

-- Dropdown اختيار الجزء
local PartDropdown = Instance.new("TextButton")
PartDropdown.Size = UDim2.new(0,180,0,30)
PartDropdown.Position = UDim2.new(0,10,0,10)
PartDropdown.Text = "اختر الجزء"
PartDropdown.BackgroundColor3 = Color3.fromRGB(255,0,0)
PartDropdown.TextColor3 = Color3.new(1,1,1)
PartDropdown.Parent = MainFrame

local PartOptions = {"Head","HumanoidRootPart","UpperTorso","LowerTorso"}
local PartSelected = "HumanoidRootPart"

PartDropdown.MouseButton1Click:Connect(function()
    PartSelected = PartOptions[(table.find(PartOptions,PartSelected) % #PartOptions)+1]
    PartDropdown.Text = PartSelected
end)

-- Toggle تتبع الكاميرا
local TrackToggle = Instance.new("TextButton")
TrackToggle.Size = UDim2.new(0,180,0,30)
TrackToggle.Position = UDim2.new(0,10,0,50)
TrackToggle.Text = "تتبع الكاميرا"
TrackToggle.BackgroundColor3 = Color3.fromRGB(255,0,0)
TrackToggle.TextColor3 = Color3.new(1,1,1)
TrackToggle.Parent = MainFrame

TrackToggle.MouseButton1Click:Connect(function()
    trackingEnabled = not trackingEnabled
    TrackToggle.BackgroundColor3 = trackingEnabled and Color3.fromRGB(0,255,0) or Color3.fromRGB(255,0,0)
end)

-- زر رينبو متدرج الألوان
local RainbowButton = Instance.new("TextButton")
RainbowButton.Size = UDim2.new(0,50,0,30)
RainbowButton.Position = UDim2.new(0,10,0,10)
RainbowButton.BackgroundColor3 = Color3.fromRGB(255,0,0)
RainbowButton.Text = ""
RainbowButton.Parent = ScreenGui

RainbowButton.MouseButton1Click:Connect(function()
    MainFrame.Visible = not MainFrame.Visible
end)

spawn(function()
    local hue = 0
    while true do
        hue = (hue + 1) % 360
        RainbowButton.BackgroundColor3 = Color3.fromHSV(hue/360,1,1)
        wait(0.03)
    end
end)

-- Get closest player
local function getClosestPlayer()
    local closest = nil
    local shortestDistance = math.huge
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character and player.Character:FindFirstChild(PartSelected) then
            local part = player.Character[PartSelected]
            local distance = (part.Position - RootPart.Position).Magnitude
            if distance < shortestDistance then
                shortestDistance = distance
                closest = player
            end
        end
    end
    return closest
end

-- Check visibility
local function isVisible(part)
    local origin = Camera.CFrame.Position
    local direction = (part.Position - origin).Unit * (part.Position - origin).Magnitude
    local ray = Ray.new(origin,direction)
    local hit = workspace:FindPartOnRayWithIgnoreList(ray,{Character})
    return hit and hit:IsDescendantOf(part.Parent)
end

-- Update Loop
RunService.RenderStepped:Connect(function()
    if trackingEnabled then
        local targetPlayer = getClosestPlayer()
        if targetPlayer and targetPlayer.Character and targetPlayer.Character:FindFirstChild(PartSelected) then
            local part = targetPlayer.Character[PartSelected]

            -- Set part color
            for _, p in pairs(targetPlayer.Character:GetDescendants()) do
                if p:IsA("BasePart") then
                    if isVisible(part) then
                        p.Color = Color3.fromRGB(0,255,0)
                        p.Transparency = 0.3
                    else
                        p.Color = Color3.fromRGB(255,0,0)
                        p.Transparency = 0
                    end
                end
            end

            -- Camera: النظر نحو الجزء
            Camera.CFrame = CFrame.new(Camera.CFrame.Position, part.Position)

            -- جسمك يتجه نحو الهدف
            local lookCFrame = CFrame.new(RootPart.Position, Vector3.new(part.Position.X, RootPart.Position.Y, part.Position.Z))
            RootPart.CFrame = CFrame.new(RootPart.Position) * CFrame.Angles(0, lookCFrame.Y - RootPart.CFrame.Y,0)
            -- تبسيط التدوير: فقط حول المحور Y
            RootPart.CFrame = CFrame.new(RootPart.Position, Vector3.new(part.Position.X, RootPart.Position.Y, part.Position.Z))
        end
    end
end)
