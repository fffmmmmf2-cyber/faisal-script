local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local camera = workspace.CurrentCamera

local player = Players.LocalPlayer

-- جدول لتخزين ESP الحالي
local currentESP = {}

-- مسح ESP الحالي
local function clearESP()
	for part, originalColor in pairs(currentESP) do
		if part and part.Parent then
			part.Color = originalColor
		end
	end
	currentESP = {}
end

-- تابع لإيجاد أقرب لاعب لنص الكاميرا
local function getClosestPlayerToScreenCenter()
	local closestPlayer = nil
	local shortestDist = math.huge
	local screenCenter = Vector2.new(camera.ViewportSize.X/2, camera.ViewportSize.Y/2)

	for _, otherPlayer in pairs(Players:GetPlayers()) do
		if otherPlayer ~= player and otherPlayer.Character and otherPlayer.Character:FindFirstChild("HumanoidRootPart") then
			local rootPos = otherPlayer.Character.HumanoidRootPart.Position
			local screenPos, onScreen = camera:WorldToViewportPoint(rootPos)
			if onScreen then
				local dist = (Vector2.new(screenPos.X, screenPos.Y) - screenCenter).Magnitude
				if dist < shortestDist then
					shortestDist = dist
					closestPlayer = otherPlayer
				end
			end
		end
	end

	return closestPlayer
end

-- تحديث ESP كل فريم
RunService.RenderStepped:Connect(function()
	clearESP()
	local target = getClosestPlayerToScreenCenter()
	if target and target.Character then
		for _, part in pairs(target.Character:GetDescendants()) do
			if part:IsA("BasePart") then
				currentESP[part] = part.Color
				part.Color = Color3.fromRGB(255,0,0) -- احمر
			end
		end
	end
end)
