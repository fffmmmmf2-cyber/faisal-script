-- LocalScript: StarterPlayerScripts/RobustCenterESP.lua
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local camera = workspace.CurrentCamera

local localPlayer = Players.LocalPlayer
if not localPlayer then
    warn("CenterESP: LocalPlayer not found (script not running as LocalScript?)")
    return
end

local HIGHLIGHT_NAME = "CenterESP_Highlight"
local lastTarget = nil
local CHECK_INTERVAL = 0.03 -- تردد فريم (تقريباً 30ms)

-- إضافة Highlight لكاركتر
local function addHighlightToCharacter(char)
    if not char or not char.Parent then return end
    if char:FindFirstChild(HIGHLIGHT_NAME) then return end

    local hl = Instance.new("Highlight")
    hl.Name = HIGHLIGHT_NAME
    hl.Adornee = char
    hl.FillTransparency = 1
    hl.OutlineTransparency = 0
    hl.OutlineColor = Color3.fromRGB(255, 0, 0)
    hl.Parent = char
end

-- إزالة Highlight من كاركتر
local function removeHighlightFromCharacter(char)
    if not char then return end
    local existing = char:FindFirstChild(HIGHLIGHT_NAME)
    if existing then existing:Destroy() end
end

-- إرجاع أقرب لاعب لمركز الشاشة (يرجع Player أو nil)
local function getClosestPlayerToScreenCenter()
    if not camera then return nil end
    local screenCenter = Vector2.new(camera.ViewportSize.X * 0.5, camera.ViewportSize.Y * 0.5)
    local bestPlayer = nil
    local bestDist = math.huge

    for _, other in pairs(Players:GetPlayers()) do
        if other ~= localPlayer and other.Character and other.Character.Parent then
            local part = other.Character:FindFirstChild("Head") or other.Character:FindFirstChild("HumanoidRootPart")
            if part then
                local screenPoint, onScreen = camera:WorldToViewportPoint(part.Position)
                -- تأكد أن الجزء أمام الكاميرا (z > 0)
                if screenPoint.Z > 0 then
                    local pos2 = Vector2.new(screenPoint.X, screenPoint.Y)
                    local dist = (pos2 - screenCenter).Magnitude
                    if dist < bestDist then
                        bestDist = dist
                        bestPlayer = other
                    end
                end
            end
        end
    end

    return bestPlayer, bestDist
end

-- دالة لمتابعة التغيير
local timeAccumulator = 0
RunService.RenderStepped:Connect(function(dt)
    timeAccumulator = timeAccumulator + dt
    if timeAccumulator < CHECK_INTERVAL then return end
    timeAccumulator = 0

    -- تأكد من وجود شخصية للاعب المحلي وكاميرا
    if not localPlayer.Character or not camera then
        if lastTarget then
            removeHighlightFromCharacter(lastTarget.Character)
            lastTarget = nil
        end
        return
    end

    local target, dist = getClosestPlayerToScreenCenter()

    if target ~= lastTarget then
        -- نزيل هلايت القديم
        if lastTarget and lastTarget.Character then
            removeHighlightFromCharacter(lastTarget.Character)
            print("CenterESP: Removed highlight from", lastTarget.Name)
        end

        if target and target.Character then
            addHighlightToCharacter(target.Character)
            print(("CenterESP: Added highlight to %s (dist=%.1f)"):format(target.Name, dist or 0))
        else
            print("CenterESP: No target found")
        end

        lastTarget = target
    end
end)

-- تنظيف عند الخروج أو إعادة التحميل
local function cleanup()
    if lastTarget and lastTarget.Character then
        removeHighlightFromCharacter(lastTarget.Character)
    end
end

localPlayer.AncestryChanged:Connect(function()
    cleanup()
end)
